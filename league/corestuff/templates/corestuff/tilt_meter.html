{% extends "corestuff/base.html" %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center w-full py-6">
    
    <div class="w-full max-w-2xl bg-[#1a1a2e]/90 border border-gray-700 rounded-3xl p-8 flex flex-col items-center space-y-8 shadow-2xl">
        
        <div class="text-center">
            <h1 class="text-5xl font-black italic tracking-tighter text-white">
                TILT <span class="text-red-500">METER</span>
            </h1>
            <p class="text-gray-500 text-xs uppercase tracking-[0.4em] mt-2 font-bold">Mental Health Diagnostic</p>
        </div>

        <div class="w-full px-4">
            <div class="w-full h-8 bg-black rounded-full border-2 border-gray-700 overflow-hidden shadow-inner flex items-center p-1">
                <div id="tilt-bar" class="h-full w-0 bg-green-500 rounded-full transition-all duration-1000 ease-out"></div>
            </div>
            <div class="flex justify-between mt-2 px-2 text-[10px] text-gray-500 font-bold uppercase">
                <span>Total Zen</span>
                <span>Mental Boom</span>
            </div>
        </div>

        <div class="w-full flex justify-center py-2">
            <button id="roll-tilt" type="button"
                class="w-full sm:w-2/3 py-5 bg-red-600 hover:bg-red-500 text-white font-black rounded-2xl shadow-[0_6px_0_rgb(153,27,27)] active:shadow-none active:translate-y-1 transition-all duration-75 uppercase tracking-widest text-xl">
                Measure Tilt ðŸ˜ˆ
            </button>
        </div>

        <div id="result-area" class="w-full border-t border-gray-800 pt-8 min-h-[300px] flex flex-col items-center">
            <div id="placeholder" class="text-gray-600 italic mt-10">Awaiting input from tilted player...</div>
            
            <div id="tilt-content" class="hidden w-full flex flex-col items-center">
                <div id="tilt-emoji" class="text-8xl mb-4 drop-shadow-2xl"></div>
                <h2 id="tilt-level" class="text-2xl font-black text-white text-center uppercase"></h2>
                <p id="tilt-meme" class="text-gray-400 italic text-center mt-2 px-6"></p>
                <p id="tilt-rare" class="text-yellow-400 font-bold text-lg mt-4 animate-pulse"></p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full mt-10">
                    <div class="bg-gray-800/50 p-4 rounded-2xl border border-gray-700">
                        <span class="text-[10px] text-red-400 font-bold uppercase tracking-widest block mb-1">Primary Scapegoat</span>
                        <p id="diag-blame" class="text-white font-bold text-lg"></p>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-2xl border border-gray-700">
                        <span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest block mb-1">Career Outlook</span>
                        <p id="diag-outlook" class="text-white font-bold text-lg"></p>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-2xl border border-gray-700 md:col-span-2">
                        <span class="text-[10px] text-green-400 font-bold uppercase tracking-widest block mb-1">Recovery Prescription</span>
                        <p id="diag-prescription" class="text-white italic text-lg"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tiltBar = document.getElementById('tilt-bar');
    const tiltLevel = document.getElementById('tilt-level');
    const tiltMeme = document.getElementById('tilt-meme');
    const tiltEmoji = document.getElementById('tilt-emoji');
    const tiltRare = document.getElementById('tilt-rare');
    const diagBlame = document.getElementById('diag-blame');
    const diagOutlook = document.getElementById('diag-outlook');
    const diagPrescription = document.getElementById('diag-prescription');
    const rollButton = document.getElementById('roll-tilt');
    const placeholder = document.getElementById('placeholder');
    const tiltContent = document.getElementById('tilt-content');

    function updateTilt() {
        rollButton.innerText = "Scanning Brain...";
        rollButton.disabled = true;

        fetch("/api/tilt-meter/")
            .then(res => res.json())
            .then(data => {
                placeholder.classList.add('hidden');
                tiltContent.classList.remove('hidden');

                // Update Bar (Min 5%)
                let percentage = Math.min(Math.max(data.tilt_score / 90, 5), 100);
                tiltBar.style.width = percentage + "%";

                // Color Logic
                if (data.tilt_score < 1500) tiltBar.className = "h-full transition-all duration-1000 bg-green-500 rounded-full shadow-[0_0_15px_rgba(34,197,94,0.5)]";
                else if (data.tilt_score < 5000) tiltBar.className = "h-full transition-all duration-1000 bg-yellow-400 rounded-full shadow-[0_0_15px_rgba(250,204,21,0.5)]";
                else tiltBar.className = "h-full transition-all duration-1000 bg-red-600 rounded-full shadow-[0_0_20px_rgba(220,38,38,0.7)]";

                // Update UI Fields
                tiltLevel.textContent = data.level;
                tiltMeme.textContent = `"${data.meme}"`;
                tiltEmoji.textContent = data.emoji;
                tiltRare.textContent = data.rare || "";
                diagBlame.textContent = data.blame;
                diagOutlook.textContent = data.outlook;
                diagPrescription.textContent = data.perscription;

                rollButton.innerText = "Roll Tilt ðŸ˜ˆ";
                rollButton.disabled = false;
            })
            .catch(err => {
                console.error("API Error:", err);
                rollButton.innerText = "System Failure!";
                rollButton.disabled = false;
            });
    }

    rollButton.addEventListener('click', updateTilt);
});
</script>
{% endblock %}